import TestbedCreate from "../testbed-create.mdx";
import GitCheckoutMain from "../git-checkout-main.mdx";
import RunMainRelative from "../run-main-relative.mdx";
import ThresholdCreateRelative from "../threshold-create-relative.mdx";
import GitCheckoutFeature from "../git-checkout-feature.mdx";
import RunFeatureRelative from "../run-feature-relative.mdx";

## Relative Continuous Benchmarking

Picking up where we left off in the
[Quick Start][quick start] and [Docker Self-Hosted][docker self-hosted] tutorials,
let's add Relative [Continuous Benchmarking][continuous benchmarking] to our `Save Walter White` project.

> 🐰 Make sure you have
> [created an API token and set it as the `BENCHER_API_TOKEN` environment variable][create an api token]
> before continuing on!

First, we need to create a new Testbed to represent our CI runners, aptly named `ci-runner`.

<TestbedCreate />

1. Use the `bencher testbed create` CLI subcommand.
   See [the `testbed create` docs][testbed create] for more details.
   (ex: `bencher testbed create`)
2. Set the `--name` option to the desired Testbed name.
   (ex: `--name ci-runner`)
3. Specify the project argument as the `Save Walter White` project slug.
   (ex: `save-walter-white-1234abcd`)

Relative Continuous Benchmarking runs a side-by-side comparison of two versions of your code.
This can be useful when dealing with noisy CI/CD environments,
where the resources available can be highly variable between runs.
In this example we will be comparing the results from running on the `main` branch
to results from running on a feature branch named `feature-branch`.
Because every CI environment is a little bit different,
the following example is meant to be more illustrative than practical.
For more specific examples, see [Continuous Benchmarking in GitHub Actions][github actions]
and [Continuous Benchmarking in GitLab CI/CD][gitlab ci/cd].

First, we need to checkout the `main` branch with `git` in CI:

<GitCheckoutMain />

Then we need to run our benchmarks on the `main` branch in CI:

<RunMainRelative />

1. Use the <code><a href="/docs/explanation/bencher-run/">bencher run</a></code> CLI subcommand
   to run your `main` branch benchmarks.
   See [the `bencher run` CLI subcommand][bencher run] for a full overview.
   (ex: `bencher run`)
2. Set the `--project` option to the Project slug.
   See [the `--project` docs][project option] for more details.
   (ex: `--project save-walter-white-1234abcd`)
3. Set the `--branch` option to the feature Branch name.
   See [branch selection][branch selection branch] for a full overview.
   (ex: `--branch feature-branch`)
4. Set the `--branch-reset` flag.
   See [branch selection][branch selection reset] for a full overview.
   (ex: `--branch-reset`)
5. Set the `--testbed` option to the Testbed name.
   See [the `--tested` docs][testbed option] for more details.
   (ex: `--testbed ci-runner`)
6. Set the `--adapter` option to the desired benchmark harness adapter.
   See [benchmark harness adapters][adapters] for a full overview.
   (ex: `--adapter json`)
7.  Specify the benchmark command arguments.
    See [benchmark command][command argument] for a full overview.
    (ex: `bencher mock`)

The first time this is command is run in CI,
it will create the `feature-branch` Branch since it does not exist yet.
The new `feature-branch` will _not_ have a start point, existing data, or Thresholds.
On subsequent runs, the old version of `feature-branch` will be renamed
and a new `feature-branch` will be created without a start point, existing data, or Thresholds.

Next, we need to create a new [Threshold][thresholds] in CI for our new `feature-branch` Branch:

<ThresholdCreateRelative />

1. Use the `bencher threshold create` CLI subcommand.
   See [the `threshold create` docs][threshold create] for more details.
   (ex: `bencher threshold create`)
2. Set the `--branch` option to the new `feature-branch` Branch.
   (ex: `--branch feature-branch`)
3. Set the `--branch` option to the `ci-runner` Testbed.
   (ex: `--testbed ci-runner`)
4. Set the `--measure` option to the built-in `Latency` Measure that is generated by `bencher mock`.
   See [the definition of Measure][measure] for more details.
   (ex: `--measure Latency`)
5. Set the `--test` option to a `percentage` Threshold.
   See [Thresholds & Alerts][percentage] for a full overview.
   (ex: `--test t-test`)
6. Set the `--upper-boundary` option to an Upper Boundary of `0.25` (ie `25%`).
   See [Thresholds & Alerts][percentage upper boundary] for a full overview.
   (ex: `--upper-boundary 0.25`)
7. Specify the project argument as the `Save Walter White` project slug.
   (ex: `save-walter-white-1234abcd`)

Then, we need to checkout the `feature-branch` branch with `git` in CI:

<GitCheckoutFeature />

Finally, we are ready to run our `feature-branch` benchmarks in CI:

<RunFeatureRelative />

1. Use the <code><a href="/docs/explanation/bencher-run/">bencher run</a></code> CLI subcommand
   to run your `feature-branch` benchmarks.
   See [the `bencher run` CLI subcommand][bencher run] for a full overview.
   (ex: `bencher run`)
2. Set the `--project` option to the Project slug.
   See [the `--project` docs][project option] for more details.
   (ex: `--project save-walter-white-1234abcd`)
3. Set the `--branch` option to the feature Branch name.
   See [branch selection][branch selection branch] for a full overview.
   (ex: `--branch feature-branch`)
4. Set the `--testbed` option to the Testbed name.
   See [the `--tested` docs][testbed option] for more details.
   (ex: `--testbed ci-runner`)
5. Set the `--adapter` option to the desired benchmark harness adapter.
   See [benchmark harness adapters][adapters] for a full overview.
   (ex: `--adapter json`)
6. Set the `--err` flag to fail the command if an Alert is generated.
   See [Threshold & Alerts][alerts] for a full overview.
   (ex: `--err`)
7. Specify the benchmark command arguments.
   See [benchmark command][command argument] for a full overview.
   (ex: `bencher mock`)

Every time this command is run in CI,
it is comparing the results from `feature-branch` against only the most recent results from `main`.

[quick start]: /docs/tutorial/quick-start/
[docker self-hosted]: /docs/tutorial/docker/
[continuous benchmarking]: /docs/explanation/continuous-benchmarking/
[create an api token]: /docs/tutorial/quick-start/#create-an-api-token
[testbed create]: /docs/api/projects/testbeds/#post-v0projectsprojecttestbeds
[github actions]: /docs/how-to/github-actions/
[gitlab ci/cd]: /docs/how-to/gitlab-ci-cd/
[bencher run]: /docs/explanation/bencher-run/
[project option]: /docs/explanation/bencher-run/#--project-project
[branch selection branch]: /docs/explanation/branch-selection/#--branch-branch
[branch selection reset]: /docs/explanation/branch-selection/#--branch-reset
[testbed option]: /docs/explanation/bencher-run/#--testbed-testbed
[adapters]: /docs/explanation/adapters/
[command argument]: /docs/explanation/bencher-run/#benchmark-command
[thresholds]: /docs/explanation/thresholds/
[threshold create]: /docs/api/projects/thresholds/#post-v0projectsprojectthresholds
[measure]: /docs/explanation/benchmarking/#measures
[percentage]: /docs/explanation/thresholds/#percentage-thresholds
[percentage upper boundary]: /docs/explanation/thresholds/#percentage-threshold-upper-boundary
[alerts]: /docs/explanation/thresholds/#alerts
